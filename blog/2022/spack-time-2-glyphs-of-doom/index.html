<!DOCTYPE html> <html lang="en"> <head> <meta charset="utf-8"> <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"> <meta http-equiv="X-UA-Compatible" content="IE=edge"> <title>Spack Time 2: Pigz flying off glyphs of doom | Shern Ren Tee</title> <meta name="author" content="Shern Ren Tee"/> <meta name="description" content="unconventional molecular dynamics researcher, open source scientific coder, sleep-deprived father "/> <meta name="keywords" content="molecular-dynamics, nonequilibrium, statistical-mechanics, constant-potential, electrode, LAMMPS, C++, FAIR, open-source, academia "/> <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous"/> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous"> <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light"/> <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>⚛️</text></svg>"> <link rel="stylesheet" href="/assets/css/main.css"> <link rel="canonical" href="https://srtee.github.io/blog/2022/spack-time-2-glyphs-of-doom/"> <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark"/> <script src="/assets/js/theme.js"></script> <script src="/assets/js/dark_mode.js"></script> </head> <body class="fixed-top-nav "> <header> <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top"> <div class="container"> <a class="navbar-brand title font-weight-lighter" href="/"><span class="font-weight-bold">Shern </span>Ren Tee</a> <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation"> <span class="sr-only">Toggle navigation</span> <span class="icon-bar top-bar"></span> <span class="icon-bar middle-bar"></span> <span class="icon-bar bottom-bar"></span> </button> <div class="collapse navbar-collapse text-right" id="navbarNav"> <ul class="navbar-nav ml-auto flex-nowrap"> <li class="nav-item "> <a class="nav-link" href="/">about</a> </li> <li class="nav-item active"> <a class="nav-link" href="/blog/">blog<span class="sr-only">(current)</span></a> </li> <li class="nav-item "> <a class="nav-link" href="/projects/">projects</a> </li> <li class="nav-item "> <a class="nav-link" href="/publications/">publications</a> </li> <li class="toggle-container"> <button id="light-toggle" title="Change theme"> <i class="fas fa-moon" title="Change to Dark theme"></i> <i class="fas fa-sun" title="Change to Light theme"></i> </button> </li> </ul> </div> </div> </nav> </header> <div class="container mt-5"> <div class="post"> <header class="post-header"> <h1 class="post-title">Spack Time 2: Pigz flying off glyphs of doom</h1> <p class="post-meta">October 4, 2022</p> <p class="post-tags"> <a href="/blog/2022"> <i class="fas fa-calendar fa-sm"></i> 2022 </a>   ·   <a href="/blog/tag/spack"> <i class="fas fa-hashtag fa-sm"></i> spack</a>   <a href="/blog/tag/doco"> <i class="fas fa-hashtag fa-sm"></i> doco</a>   </p> </header> <article class="post-content"> <h2 id="gcc-aka-getting-code-compiled">GCC, aka Getting Code Compiled</h2> <p>Last I wrote, I’d typed in:</p> <p><code class="language-plaintext highlighter-rouge">spack install lammps</code></p> <p>An hour of computer time later, everything had Just Worked! Amazing!</p> <p>Excitedly, I fired up my new install with a <code class="language-plaintext highlighter-rouge">spack load lammps</code> and confirmed that I had … the 2021 stable version of LAMMPS. That was exciting in itself, because this confirmed that I could smoothly switch between my custom-compiled LAMMPS versions (based off the Sept 2022 patch) and what Spack had built. Time to build the latest version:</p> <p><code class="language-plaintext highlighter-rouge">spack install lammps@20220623</code></p> <p>and again, everything Just Worked!</p> <h2 id="time-to-get-my-oneapi-on">Time to get my OneAPI on</h2> <p>Following <a href="https://spack.readthedocs.io/en/latest/build_systems/inteloneapipackage.html" target="_blank" rel="noopener noreferrer">Spack’s instructions</a>, I installed the latest versions of Intel’s OneAPI and linked it up with Spack. That didn’t cause any trouble, which is notable because using Intel compilers on clusters has caused me grief in the past.</p> <p>So now it was time to get Spack going on my next big job:</p> <p><code class="language-plaintext highlighter-rouge">spack install lammps@20220915 %oneapi ^intel-oneapi-mkl ^intel-oneapi-mpi</code></p> <p>Let’s unspack<sup id="fnref:1" role="doc-noteref"><a href="#fn:1" class="footnote" rel="footnote">1</a></sup> the “sigils” Spack uses:</p> <ol> <li> <code class="language-plaintext highlighter-rouge">@</code> denotes a version string – LAMMPS uses patch dates, I’m not sure what Spack does with other packages.</li> <li> <code class="language-plaintext highlighter-rouge">%</code> denotes the compiler used.</li> <li> <code class="language-plaintext highlighter-rouge">^</code> denotes a specific dependency, because Spack can track abstract dependencies – for example, Spack knows that LAMMPS can use any MPI, so <code class="language-plaintext highlighter-rouge">^intel-oneapi-mpi</code> will tell Spack to use Intel MPI in that slot.</li> </ol> <p>And of course, everything compiled perfectly, and Shern coded happily ever after … <em>not</em>.</p> <h2 id="the-glyphs-of-doom">The glyphs of doom!</h2> <p>The first package which refused to compile was … <code class="language-plaintext highlighter-rouge">font-util</code>! This was an unpleasant surprise. If you’re familiar with LAMMPS you will be wondering, <em>why</em>? LAMMPS is after all a command-line-only molecular dynamics simulator, so what on earth is it doing looking for fonts? I haven’t looked at the dependency graphs but my guess is that some of the output modes probably feature fonts and therefore ask for <code class="language-plaintext highlighter-rouge">font-util</code> – or perhaps some other package in line has some odd dependency there.</p> <p>In any case, I was staring this right in the face:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>     12934    /home/shernren/anaconda3/bin/fc-cache /home/shernren/spack/opt/spack/linux-ubuntu22.04-zen/oneapi-2022.1.0/font-util-1.3.2-yvqiyb6jnjnpo5ocw5nh4bfcplh2yqhq/share/fonts/X11/cyrillic
     12935    /home/shernren/spack/opt/spack/linux-ubuntu22.04-zen/oneapi-2022.1.0/font-util-1.3.2-yvqiyb6jnjnpo5ocw5nh4bfcplh2yqhq/share/fonts/X11/cyrillic: failed to write cache
  &gt;&gt; 12936    make[2]: *** [Makefile:755: install-data-hook] Error 1
     12937    make[2]: Leaving directory '/tmp/shernren/spack-stage/spack-stage-font-util-1.3.2-yvqiyb6jnjnpo5ocw5nh4bfcplh2yqhq/spack-src/font-cronyx-cyrillic/font-cronyx-cyrillic-1.0.3'
  &gt;&gt; 12938    make[1]: *** [Makefile:681: install-data-am] Error 2
     12939    make[1]: Leaving directory '/tmp/shernren/spack-stage/spack-stage-font-util-1.3.2-yvqiyb6jnjnpo5ocw5nh4bfcplh2yqhq/spack-src/font-cronyx-cyrillic/font-cronyx-cyrillic-1.0.3'
  &gt;&gt; 12940    make: *** [Makefile:632: install-am] Error 2
</code></pre></div></div> <p>Urgh! Argh! What on Earth! I duly googled “failed to write cache” and dived into a morass of old, odd bug reports. Eventually, it turned out that (1) this was <a href="https://gitlab.freedesktop.org/fontconfig/fontconfig/-/issues/107" target="_blank" rel="noopener noreferrer">an old bug in fontconfig</a>; (2) it was being triggered by <em>fontconfig from my Anaconda</em>.</p> <p>Of course Spack can’t solve my snake issues. But what I like about Spack is that, to me at least, it seems more transparent about the whole process. Instead of downloading wheels which magically go round and round and end up making my bus go forward, Spack is just (!) downloading source, compiling, and installing, and it happens to keep track of all its work with the hashes to show for it. I tacked on a few extra options: <code class="language-plaintext highlighter-rouge">-v --keep-prefix</code> to, respectively, give verbose output and keep all its temporary files around after a failed install. The install files eventually let me confirm that, yes, my Anaconda <code class="language-plaintext highlighter-rouge">fc-cache</code> was bugged while <code class="language-plaintext highlighter-rouge">/usr/bin/fc-cache</code> was updated to the latest version. After a quick and very dirty:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mv ~/anaconda/bin/fc-cache ~/anaconda/bin/fc-cache-old
ln -s /usr/bin/fc-cache ~/anaconda/bin/fc-cache
</code></pre></div></div> <p>I was on my way!</p> <h2 id="pigz-go-fly">Pigz go fly</h2> <p>Almost immediately another package decided to lie down and not compile, and it was <a href="https://zlib.net/pigz/" target="_blank" rel="noopener noreferrer"><code class="language-plaintext highlighter-rouge">pigz</code></a>. Another unpleasant surprise with an even more cryptic error message:</p> <div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>==&gt; [2022-10-04-21:59:46.995345] 'make' '-j8'
gcc -O3 -Wall -Wextra -Wno-unknown-pragmas -Wcast-qual   -c -o pigz.o pigz.c
make: gcc: Permission denied
make: *** [&lt;builtin&gt;: pigz.o] Error 127
==&gt; Error: ProcessError: Command exited with status 2:
    'make' '-j8'

2 errors found in build log:
  &gt;&gt; 6    make: gcc: Permission denied
  &gt;&gt; 7    make: *** [&lt;builtin&gt;: pigz.o] Error 127
</code></pre></div></div> <p>Well, not very cryptic, in that I wasn’t able to use GCC while wanting to build everything with Intel’s ICPX! That again is a good sign that Spack really was going to compile everything with ICPX or die trying.</p> <p>But why was <code class="language-plaintext highlighter-rouge">pigz</code> asking for GCC? Again, Spack helpfully saved the source tar for me to peruse, and what should I find at the top of the Makefile but <code class="language-plaintext highlighter-rouge">CC=gcc</code>! Well, I don’t know how to get Spack to override the source it downloads<sup id="fnref:2" role="doc-noteref"><a href="#fn:2" class="footnote" rel="footnote">2</a></sup>, but I knew I was never going to ask “but what if I compiled a parallel GZ compressor with Intel instead of GCC?”, so off we go changing the dependencies again:</p> <p><code class="language-plaintext highlighter-rouge">spack install lammps@20220915 %oneapi ^intel-oneapi-mkl ^intel-oneapi-mpi ^pigz%gcc</code></p> <p>And … it all worked! This last command has been running the whole time I’ve been typing this entry, and it’s built (glances at other terminal) an entire new Python, LLVM for AMD GPU (which, whoops, it’s just tripped over), and (hilariously) <em>a new fontconfig</em>, which would have been nice to have while font-util was tripping over itself!</p> <p>And instead of deciding to stop here (I can see it’s already decided that it can’t build Intel MPI without that mysterious AMD GPU LLVM, and therefore that it can’t build LAMMPS – sensible), it’s gone on now to build <em>Rust</em>!</p> <h2 id="if-only-this-were-a-conclusion">If only this were a conclusion</h2> <p>It seems that the journey goes on and on. But what I can tell is that Spack really, really does prioritize documenting a reproducible build. Of course it takes a lot of disk space to rebuild everything just to make sure it’s the same compiler throughout – but in the intended HPC use case, that totally makes sense.</p> <p>Even though I’m laughing (and crying) and some of the more ridiculous errors here, I don’t think they’re Spack’s fault. If I were building LAMMPS from ground up, especially with a list of different compilers and some of the more esoteric sub-packages, I’d be running headfirst into these speed bumps too. Spack is simply doing what I want it to do – and doing an admirable job keeping track of it all, and giving me the information I need to –</p> <p>dear heavens above, why is it building me <em>a brand new NumPy</em>???</p> <div class="footnotes" role="doc-endnotes"> <ol> <li id="fn:1" role="doc-endnote"> <p>I love my puns and I will not lie. <a href="#fnref:1" class="reversefootnote" role="doc-backlink">↩</a></p> </li> <li id="fn:2" role="doc-endnote"> <p>Spack does have a “develop mode” where it will build from my specified source directory instead of downloading from a Git repository. But I want to reserve that for developing LAMMPS, not pigz, and so I’ll wait until I have all my reference binaries compiled before tinkering with that. <a href="#fnref:2" class="reversefootnote" role="doc-backlink">↩</a></p> </li> </ol> </div> </article> </div> </div> <footer class="fixed-bottom"> <div class="container mt-0"> © Copyright 2024 Shern Ren Tee. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>. Photos from <a href="https://unsplash.com" target="_blank" rel="noopener noreferrer">Unsplash</a>. </div> </footer> <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.bundle.min.js" integrity="sha256-fgLAgv7fyCGopR/gBNq2iW3ZKIdqIcyshnUULC4vex8=" crossorigin="anonymous"></script> <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script> <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script> <script defer src="/assets/js/masonry.js" type="text/javascript"></script> <script defer src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script> <script defer src="/assets/js/zoom.js"></script> <script defer src="/assets/js/common.js"></script> <script type="text/javascript">window.MathJax={tex:{tags:"ams"}};</script> <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script> <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> </body> </html>